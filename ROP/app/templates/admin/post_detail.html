<!DOCTYPE html>
{% load static %}
<html lang="vi">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Chi ti·∫øt b√†i ƒëƒÉng - {{ job.title }}</title>
    <link rel="stylesheet" href="{% static 'app/css/post_detail.css' %}"/>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link rel="stylesheet" href="{% static 'app/css/nav.css' %}"/>
</head>
<body>
{% include "admin/header.html" %}

<div class="page-container">
    <div class="job-detail-section">
        <div class="detail-card">
            <h1>{{ job.title }}</h1>

            <div class="company-info">{{ job.company }}</div>

            <div class="key-info">
                <div>
                    <span>üìç ƒê·ªãa ƒëi·ªÉm</span>
                    <strong>{{ job.location }}</strong>
                </div>
                <div>
                    <span>üí∞ M·ª©c l∆∞∆°ng</span>
                    <strong>
                        {% if job.salary_min and job.salary_max %} {{ job.salary_min }} - {{ job.salary_max }} Tri·ªáu VND
                        {% elif job.salary_min %}
                        T·ª´ {{ job.salary_min }} Tri·ªáu VND {% else %} Th·ªèa thu·∫≠n {% endif %}
                    </strong>
                </div>
                <div>
                    <span>Th·ªùi gian</span>
                    <strong>{{ job.create_at|date:"d/m/Y" }} - {{ job.end_date|date:"d/m/Y" }}</strong>
                </div>
            </div>

            <div class="content-section">
                <h2>M√¥ T·∫£ C√¥ng Vi·ªác</h2>
                <ul>
                    {% for item in jobDescript %}
                    <li>{{ item }}</li>
                    {% empty %}
                    <li>Kh√¥ng c√≥ th√¥ng tin</li>
                    {% endfor %}
                </ul>

                <h2>Y√™u C·∫ßu C√¥ng Vi·ªác</h2>
                <ul>
                    {% for item in jobRequire %}
                    <li>{{ item }}</li>
                    {% empty %}
                    <li>Kh√¥ng c√≥ th√¥ng tin</li>
                    {% endfor %}
                </ul>

                <h2>K·ªπ NƒÉng</h2>
                <ul>
                    {% for item in jobSkill %}
                    <li>{{ item }}</li>
                    {% empty %}
                    <li>Kh√¥ng y√™u c·∫ßu c·ª• th·ªÉ</li>
                    {% endfor %}
                </ul>

                <h2>Ph√∫c L·ª£i</h2>
                <ul>
                    {% for item in jobBenefit %}
                    <li>{{ item }}</li>
                    {% empty %}
                    <li>Kh√¥ng c√≥ th√¥ng tin</li>
                    {% endfor %}
                </ul>
            </div>

            <!-- N√öT M·ªû MODAL CV -->
            <div class="filter-btn-container my-4 text-center">
                {% if total_cvs > 0 %}
                <button class="btn btn-lg btn-success shadow recommend-btn" data-bs-toggle="modal" data-bs-target="#cvModal">
                    <i class="fas fa-file-alt me-2"></i>Danh s√°ch CV ·ª©ng tuy·ªÉn & ƒê√°nh gi√° AI ({{ total_cvs }} CV)
                </button>
                {% else %}
                <button class="btn btn-lg btn-secondary" disabled>
                    <i class="fas fa-inbox me-2"></i>Ch∆∞a c√≥ CV n√†o ·ª©ng tuy·ªÉn
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- MODAL HI·ªÇN TH·ªä CV + AI SCORE -->
<div class="modal fade" id="cvModal" tabindex="-1" aria-labelledby="cvModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="cvModalLabel">
                    üéØ ƒê√°nh gi√° AI: CV ph√π h·ª£p v·ªõi "{{ job.title }}"
                    <span class="badge bg-light text-dark ms-2">{{ total_cvs }} CV</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <!-- B·ªô l·ªçc s·∫Øp x·∫øp -->
                <div class="filter-controls mb-4 p-3 bg-light rounded">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">S·∫Øp x·∫øp theo</label>
                            <select id="sort-by" class="form-select">
                                <option value="score_desc">ƒêi·ªÉm AI cao nh·∫•t</option>
                                <option value="score_asc">ƒêi·ªÉm AI th·∫•p nh·∫•t</option>
                                <option value="date_desc">M·ªõi nh·∫•t</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- T√ôY CH·ªàNH TR·ªåNG S·ªê -->
                <div class="score-controls mb-4 p-3 border rounded bg-light">
                    <h6 class="mb-3 text-primary fw-bold">T√πy ch·ªânh tr·ªçng s·ªë t√≠nh ƒëi·ªÉm AI (ch·ªâ ·∫£nh h∆∞·ªüng hi·ªÉn th·ªã trong popup)</h6>
                    
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">M√¥ t·∫£ / Y√™u c·∫ßu (%)</label>
                            <input type="number" id="req-weight" class="form-control" value="50" min="0" max="100" step="5">
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">K·ªπ nƒÉng (%)</label>
                            <input type="number" id="skill-weight" class="form-control" value="40" min="0" max="100" step="5">
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">ƒê·ªãa ƒëi·ªÉm (%)</label>
                            <input type="number" id="loc-weight" class="form-control" value="10" min="0" max="100" step="5">
                        </div>

                        <div class="col-12 mt-3">
                            <button class="btn btn-success w-100 fw-bold" id="recalculateScore">
                                <i class="fas fa-calculator me-2"></i>T√≠nh l·∫°i ƒëi·ªÉm theo tr·ªçng s·ªë m·ªõi
                            </button>
                        </div>
                    </div>

                    <small class="text-muted mt-2 d-block">
                        T·ªïng tr·ªçng s·ªë kh√¥ng nh·∫•t thi·∫øt ph·∫£i b·∫±ng 100, nh∆∞ng khuy·∫øn ngh·ªã ƒë·ªÉ k·∫øt qu·∫£ ch√≠nh x√°c.
                    </small>
                </div>

                <!-- B·∫£ng CV -->
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="cv-table">
                        <thead class="table-dark">
                        <tr>
                            <th>ƒêi·ªÉm AI</th>
                            <th>·ª®ng vi√™n</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for analysis in cv_analyses %}
                        <tr data-score="{{ analysis.score|default:0 }}"
                            data-date="{{ analysis.application.applied_at|date:'c' }}"
                            data-req-score="{{ analysis.field_scores.requirements_score|default:0 }}"
                            data-skill-score="{{ analysis.field_scores.skills_score|default:0 }}"
                            data-loc-score="{{ analysis.field_scores.location_score|default:0 }}">
                            <td>
                                <strong class="fs-5 score-display">{{ analysis.score|floatformat:1|default:"0" }}</strong><br/>
                                <span class="badge match-level-badge {% if analysis.score > 80 %}bg-success{% elif analysis.score > 60 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                    {{ analysis.match_level|default:"Th·∫•p" }}
                                </span>
                            </td>
                            <td>
                                <strong>{{ analysis.display_name }}</strong><br/>
                                <small class="text-muted">{{ analysis.parsed.email }}</small>
                            </td>

                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary view-cv-btn"
                                            data-cv="{{ analysis.cv.id }}"
                                            data-job="{{ job.id }}">Chi ti·∫øt</button>

                                    <a href="{% url 'application_pdf_download' analysis.application.id %}" 
                                       class="btn btn-sm btn-outline-primary">Xu·∫•t PDF</a>

                                    {% if analysis.application.is_sent %}
                                    <button class="btn btn-sm btn-success" disabled>
                                        <i class="bi bi-check-circle"></i> ƒê√£ g·ª≠i
                                    </button>
                                    {% else %}
                                    <button type="button"
                                            class="btn btn-sm btn-outline-success btn-send-email"
                                            data-url="{% url 'send_interview_email' analysis.application.id %}">
                                        <i class="bi bi-envelope"></i> G·ª≠i mail
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center py-5 text-muted">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <h5>Ch∆∞a c√≥ CV n√†o ·ª©ng tuy·ªÉn</h5>
                                <p>H√£y ch·ªù ·ª©ng vi√™n n·ªôp h·ªì s∆°!</p>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal chi ti·∫øt CV -->
<div class="modal fade" id="cvDetailModal" tabindex="-1" aria-labelledby="cvDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="cvDetailModalLabel">Chi ti·∫øt CV</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>H·ªç v√† t√™n:</strong> <span id="cv-fullname"></span></p>
                <p><strong>Email:</strong> <span id="cv-email"></span></p>
                <p><strong>Phone:</strong> <span id="cv-phone"></span></p>
                <p><strong>ƒê·ªãa ch·ªâ:</strong> <span id="cv-address"></span></p>
                <p><strong>K·ªπ nƒÉng / kinh nghi·ªám:</strong></p>
                <pre id="cv-skills"></pre>
                <p><strong>M√¥ t·∫£:</strong></p>
                <pre id="cv-description"></pre>
                <p><strong>ƒêi·ªÉm AI:</strong> <span id="cv-score"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal g·ª≠i mail ph·ªèng v·∫•n -->
<div class="modal fade" id="interviewDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Th√¥ng tin bu·ªïi ph·ªèng v·∫•n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="pending_app_id">
                <div class="mb-3">
                    <label class="form-label">Ng√†y & Gi·ªù ph·ªèng v·∫•n</label>
                    <input type="datetime-local" id="interview_time" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">ƒê·ªãa ƒëi·ªÉm</label>
                    <input type="text" id="interview_location" class="form-control"
                           placeholder="Link Zoom ho·∫∑c ƒë·ªãa ch·ªâ c√¥ng ty">
                </div>
                <div class="mb-3">
                    <label class="form-label">T√†i li·ªáu c·∫ßn chu·∫©n b·ªã</label>
                    <textarea id="interview_docs" class="form-control" rows="3"
                              placeholder="V√≠ d·ª•: CCCD, b·∫±ng c·∫•p g·ªëc..."></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Th√¥ng tin li√™n h·ªá</label>
                    <textarea id="interview_contact" class="form-control" rows="3"
                              placeholder="S·ªë ƒëi·ªán tho·∫°i ho·∫∑c email..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" id="confirmSendMail">X√°c nh·∫≠n & G·ª≠i Mail</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- ====================== JAVASCRIPT ====================== -->

<!-- S·∫Øp x·∫øp b·∫£ng CV -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const table = document.getElementById("cv-table");
    if (!table) return;

    const tbody = table.querySelector("tbody");
    const sortSelect = document.getElementById("sort-by");
    if (!sortSelect) return;

    function sortTable() {
        const sortValue = sortSelect.value;
        const rows = Array.from(tbody.querySelectorAll("tr"));

        rows.sort((a, b) => {
            const scoreA = Number(a.dataset.score || 0);
            const scoreB = Number(b.dataset.score || 0);
            const dateA = new Date(a.dataset.date || "1970-01-01");
            const dateB = new Date(b.dataset.date || "1970-01-01");

            switch (sortValue) {
                case "score_desc": return scoreB - scoreA;
                case "score_asc": return scoreA - scoreB;
                case "date_desc": return dateB - dateA;
                default: return 0;
            }
        });

        rows.forEach(row => tbody.appendChild(row));
    }

    sortSelect.addEventListener("change", sortTable);
    sortTable(); // S·∫Øp x·∫øp m·∫∑c ƒë·ªãnh
});
</script>

<!-- Xem chi ti·∫øt CV -->
<script>
document.querySelectorAll(".view-cv-btn").forEach(btn => {
    btn.addEventListener("click", function () {
        const cvId = this.dataset.cv;
        const jobId = this.dataset.job;

        fetch(`/cv/json/${cvId}/?job_id=${jobId}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById("cv-fullname").textContent = data.full_name || "Ch∆∞a x√°c ƒë·ªãnh";
                document.getElementById("cv-email").textContent = data.email || "‚Äî";
                document.getElementById("cv-phone").textContent = data.phone || "‚Äî";
                document.getElementById("cv-address").textContent = data.address || "‚Äî";
                document.getElementById("cv-skills").textContent = data.skills || "‚Äî";
                document.getElementById("cv-description").textContent = data.description || "‚Äî";
                document.getElementById("cv-score").textContent = data.score_data
                    ? `${data.score_data.total_score} (${data.score_data.level})`
                    : "‚Äî";

                new bootstrap.Modal(document.getElementById("cvDetailModal")).show();
            })
            .catch(err => console.error("L·ªói t·∫£i chi ti·∫øt CV:", err));
    });
});
</script>

<!-- G·ª≠i mail ph·ªèng v·∫•n -->
<script>
document.querySelectorAll(".btn-send-email").forEach(button => {
    button.addEventListener("click", function () {
        const url = this.getAttribute("data-url");
        const appId = url.split('/').filter(Boolean).pop();
        document.getElementById("pending_app_id").value = appId;

        new bootstrap.Modal(document.getElementById('interviewDetailsModal')).show();
    });
});

document.getElementById("confirmSendMail")?.addEventListener("click", function () {
    const appId = document.getElementById("pending_app_id").value;
    const time = document.getElementById("interview_time").value;
    const location = document.getElementById("interview_location").value;
    const docs = document.getElementById("interview_docs").value;
    const contact = document.getElementById("interview_contact").value;

    if (!time || !location) {
        alert("Vui l√≤ng nh·∫≠p th·ªùi gian v√† ƒë·ªãa ƒëi·ªÉm!");
        return;
    }

    const btn = document.querySelector(`[data-url*="/${appId}/"]`);
    const originalHTML = btn.innerHTML;

    bootstrap.Modal.getInstance(document.getElementById('interviewDetailsModal')).hide();

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ƒêang g·ª≠i...';

    const params = new URLSearchParams({
        time: time,
        location: location,
        docs: docs,
        contact: contact
    });

    fetch(`${btn.getAttribute("data-url")}?${params}`, {
        method: "GET",
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "success") {
            btn.classList.replace("btn-outline-success", "btn-success");
            btn.innerHTML = '<i class="bi bi-check-circle"></i> ƒê√£ g·ª≠i';
            btn.disabled = true;
        } else {
            alert("L·ªói: " + (data.message || "Kh√¥ng th·ªÉ g·ª≠i email"));
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        }
    })
    .catch(err => {
        console.error(err);
        btn.innerHTML = originalHTML;
        btn.disabled = false;
        alert("C√≥ l·ªói x·∫£y ra khi g·ª≠i email");
    });
});
</script>

<!-- T√çNH L·∫†I ƒêI·ªÇM THEO TR·ªåNG S·ªê M·ªöI -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const recalcBtn = document.getElementById("recalculateScore");
    if (!recalcBtn) return;

    recalcBtn.addEventListener("click", function (e) {
        e.preventDefault();

        const reqWeight = parseFloat(document.getElementById("req-weight").value) || 0;
        const skillWeight = parseFloat(document.getElementById("skill-weight").value) || 0;
        const locWeight = parseFloat(document.getElementById("loc-weight").value) || 0;

        const totalWeight = reqWeight + skillWeight + locWeight;
        if (totalWeight === 0) {
            alert("T·ªïng tr·ªçng s·ªë ph·∫£i l·ªõn h∆°n 0!");
            return;
        }
        if (totalWeight > 100 || totalWeight < 100) {
            alert("T·ªïng tr·ªçng s·ªë ph·∫£i b·∫±ng 100!");
            return;
        }

        const rows = document.querySelectorAll("#cv-table tbody tr[data-req-score]");

        rows.forEach(row => {
            const reqScore   = parseFloat(row.dataset.reqScore)   || 0;
            const skillScore = parseFloat(row.dataset.skillScore) || 0;
            const locScore   = parseFloat(row.dataset.locScore)   || 0;

            const newTotal = 
                (reqScore   * (reqWeight / 100)) +
                (skillScore * (skillWeight / 100)) +
                (locScore   * (locWeight / 100));

            const newScore = newTotal.toFixed(1);

            let newLevel = "Th·∫•p";
            let badgeClass = "bg-danger";

            if (newScore >= 80) {
                newLevel = "R·∫•t ph√π h·ª£p";
                badgeClass = "bg-success";
            } else if (newScore >= 60) {
                newLevel = "Ph√π h·ª£p";
                badgeClass = "bg-warning text-dark";
            } else if (newScore >= 40) {
                newLevel = "Trung b√¨nh";
                badgeClass = "bg-info text-dark";
            }

            row.querySelector(".score-display").textContent = newScore;
            const badge = row.querySelector(".match-level-badge");
            if (badge) {
                badge.textContent = newLevel;
                badge.className = `badge match-level-badge ${badgeClass}`;
            }

            row.dataset.score = newScore;
        });

        // T·ª± ƒë·ªông s·∫Øp x·∫øp l·∫°i n·∫øu ƒëang sort theo ƒëi·ªÉm
        const sortSelect = document.getElementById("sort-by");
        if (sortSelect && sortSelect.value.includes("score")) {
            if (typeof sortTable === "function") {
                sortTable();
            }
        }

        // Hi·ªáu ·ª©ng n√∫t
        const originalText = recalcBtn.innerHTML;
        recalcBtn.innerHTML = '<i class="fas fa-check me-2"></i>ƒê√£ t√≠nh l·∫°i!';
        recalcBtn.classList.add("btn-outline-success");
        setTimeout(() => {
            recalcBtn.innerHTML = originalText;
            recalcBtn.classList.remove("btn-outline-success");
        }, 2500);
    });
});
</script>

</body>
</html>