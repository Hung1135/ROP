<!DOCTYPE html>
{% load static %}
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi ti·∫øt b√†i ƒëƒÉng - {{ job.title }}</title>
    <link rel="stylesheet" href="{% static 'app/css/post_detail.css' %}" />
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  </head>
  <body>
    {% include "admin/header.html" %}

    <div class="page-container">
      <div class="job-detail-section">
        <div class="detail-card">
          <h1>{{ job.title }}</h1>

          <div class="company-info">{{ job.company }}</div>

          <div class="key-info">
            <div>
              <span>üìç ƒê·ªãa ƒëi·ªÉm</span>
              <strong>{{ job.location }}</strong>
            </div>
            <div>
              <span>üí∞ M·ª©c l∆∞∆°ng</span>
              <strong>
                {% if job.salary_min and job.salary_max %} {{ job.salary_min }} - {{ job.salary_max }} Tri·ªáu VND {% elif job.salary_min %}
                T·ª´ {{ job.salary_min }} Tri·ªáu VND {% else %} Th·ªèa thu·∫≠n {% endif %}
              </strong>
            </div>
            <div>
              <span>Th·ªùi gian</span>
              <strong>{{ job.create_at }} - {{job.end_date}}</strong>
            </div>
          </div>

          <div class="content-section">
            <h2>M√¥ T·∫£ C√¥ng Vi·ªác</h2>
            <ul>
              {% for item in jobDescript %}
              <li>{{ item }}</li>
              {% empty %}
              <li>Kh√¥ng c√≥ th√¥ng tin</li>
              {% endfor %}
            </ul>

            <h2>Y√™u C·∫ßu C√¥ng Vi·ªác</h2>
            <ul>
              {% for item in jobRequire %}
              <li>{{ item }}</li>
              {% empty %}
              <li>Kh√¥ng c√≥ th√¥ng tin</li>
              {% endfor %}
            </ul>

            <h2>K·ªπ NƒÉng</h2>
            <ul>
              {% for item in jobSkill %}
              <li>{{ item }}</li>
              {% empty %}
              <li>Kh√¥ng y√™u c·∫ßu c·ª• th·ªÉ</li>
              {% endfor %}
            </ul>

            <h2>Ph√∫c L·ª£i</h2>
            <ul>
              {% for item in jobBenefit %}
              <li>{{ item }}</li>
              {% empty %}
              <li>Kh√¥ng c√≥ th√¥ng tin</li>
              {% endfor %}
            </ul>
          </div>

          <!-- N√öT M·ªû MODAL CV -->
          <div class="filter-btn-container my-4">
            {% if total_cvs > 0 %}
            <button class="recommend-btn shadow" data-bs-toggle="modal" data-bs-target="#cvModal">
              üìÑ Danh s√°ch CV ·ª©ng tuy·ªÉn & ƒê√°nh gi√° AI ({{ total_cvs }} CV)
            </button>
            {% else %}
            <button class="recommend-btn" disabled>üìÑ Ch∆∞a c√≥ CV ·ª©ng tuy·ªÉn</button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL HI·ªÇN TH·ªä CV + AI SCORE -->
    <div class="modal fade" id="cvModal" tabindex="-1" aria-labelledby="cvModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="cvModalLabel">
              üéØ ƒê√°nh gi√° AI: CV ph√π h·ª£p v·ªõi "{{ job.title }}"
              <span class="badge bg-light text-dark ms-2">{{ total_cvs }} CV</span>
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <!-- B·ªô l·ªçc -->
            <div class="filter-controls mb-4 p-3 bg-light rounded">
              <div class="row g-3 align-items-end">
                <label class="form-label">S·∫Øp x·∫øp theo</label>
                <select id="sort-by" class="form-select">
                  <option value="score_desc">ƒêi·ªÉm AI cao nh·∫•t</option>
                  <option value="score_asc">ƒêi·ªÉm AI th·∫•p nh·∫•t</option>
                  <option value="date_desc">M·ªõi nh·∫•t</option>
                </select>
              </div>
            </div>

            <!-- B·∫£ng CV -->
            <div class="table-responsive">
              <table class="table table-hover align-middle" id="cv-table">
                <thead class="table-dark">
                  <tr>
                    <th>ƒêi·ªÉm AI</th>
                    <th>·ª®ng vi√™n</th>
                    <!--                                    <th>K·ªπ nƒÉng ch√≠nh</th>-->
                    <!--                                    <th>Kinh nghi·ªám</th>-->
                    <!--                                    <th>Th·ªùi gian n·ªôp</th>-->
                    <th>H√†nh ƒë·ªông</th>
                  </tr>
                </thead>
                <tbody>
                  {% for analysis in cv_analyses %}
                  <tr data-score="{{ analysis.score|default:0 }}" data-date="{{ analysis.application.applied_at|date:'c' }}">
                    <td>
                      <strong class="fs-5">{{ analysis.score|floatformat:1|default:"0" }}</strong><br />
                      <span
                        class="badge {% if analysis.score > 80 %}bg-success {% elif analysis.score > 60 %}bg-warning text-dark {% else %}bg-danger{% endif %}"
                      >
                        {{ analysis.match_level|default:"Th·∫•p" }}
                      </span>
                    </td>
                    <td>
                      <strong>{{ analysis.display_name }}</strong><br />
                      <small class="text-muted">{{ analysis.parsed.email }}</small>
                    </td>

                    <td>
                    <div class="btn-group" role="group">
    <button class="btn btn-sm btn-outline-primary view-cv-btn" 
            data-cv="{{ analysis.cv.id }}" 
            data-job="{{ job.id }}">Chi ti·∫øt</button>

    {% if analysis.application.is_sent %}
        <button class="btn btn-sm btn-success" disabled>
            <i class="bi bi-check-circle"></i> ƒê√£ g·ª≠i xong
        </button>
    {% else %}
        <button type="button" 
                class="btn btn-sm btn-outline-success btn-send-email" 
                data-url="{% url 'send_interview_email' analysis.application.id %}">
            <i class="bi bi-envelope"></i> G·ª≠i mail ph·ªèng v·∫•n
        </button>
    {% endif %}

    {% if analysis.cv.file_name|lower|slice:"-4:" == ".pdf" %}{% endif %}
</div>
 </div>
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="6" class="text-center py-5 text-muted">
                      <i class="fas fa-inbox fa-3x mb-3"></i>
                      <h5>Ch∆∞a c√≥ CV n√†o ·ª©ng tuy·ªÉn</h5>
                      <p>H√£y ch·ªù ·ª©ng vi√™n n·ªôp h·ªì s∆° ho·∫∑c chia s·∫ª tin tuy·ªÉn d·ª•ng!</p>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal hi·ªÉn th·ªã chi ti·∫øt CV -->
    <div class="modal fade" id="cvDetailModal" tabindex="-1" aria-labelledby="cvDetailModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title" id="cvDetailModalLabel">Chi ti·∫øt CV</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p><strong>H·ªç v√† t√™n:</strong> <span id="cv-fullname"></span></p>
            <p><strong>Email:</strong> <span id="cv-email"></span></p>
            <p><strong>Phone:</strong> <span id="cv-phone"></span></p>
            <p><strong>ƒê·ªãa ch·ªâ:</strong> <span id="cv-address"></span></p>
            <p><strong>K·ªπ nƒÉng / kinh nghi·ªám:</strong></p>
            <pre id="cv-skills"></pre>
            <p><strong>M√¥ t·∫£:</strong></p>
            <pre id="cv-description"></pre>
            <p><strong>ƒêi·ªÉm AI:</strong> <span id="cv-score"></span></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JS L·ªçc & S·∫Øp x·∫øp CV -->
    <script src="{% static 'app/js/admin_cv_filter.js' %}"></script>
    <!-- N·∫øu ch∆∞a c√≥ file JS, t·∫°o file static/app/js/admin_cv_filter.js v·ªõi n·ªôi dung d∆∞·ªõi ƒë√¢y -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // L·∫•y b·∫£ng CV
        const table = document.getElementById("cv-table");
        if (!table) {
          console.warn("Kh√¥ng t√¨m th·∫•y b·∫£ng cv-table");
          return;
        }

        const tbody = table.querySelector("tbody");
        const sortSelect = document.getElementById("sort-by");

        if (!sortSelect) {
          console.warn("Kh√¥ng t√¨m th·∫•y select sort-by");
          return;
        }

        /**
         * H√†m s·∫Øp x·∫øp b·∫£ng
         */
        function sortTable() {
          const sortValue = sortSelect.value;
          const rows = Array.from(tbody.querySelectorAll("tr"));

          rows.sort((a, b) => {
            const scoreA = Number(a.dataset.score || 0);
            const scoreB = Number(b.dataset.score || 0);

            // date d·∫°ng: YYYY-MM-DD
            const dateA = new Date(a.dataset.date || "1970-01-01");
            const dateB = new Date(b.dataset.date || "1970-01-01");

            switch (sortValue) {
              case "score_desc":
                return scoreB - scoreA;

              case "score_asc":
                return scoreA - scoreB;

              case "date_desc":
                return dateB - dateA;

              default:
                return 0;
            }
          });

          // G·∫Øn l·∫°i th·ª© t·ª± m·ªõi
          rows.forEach((row) => tbody.appendChild(row));
        }

        // ƒê·ªïi option l√† s·∫Øp x·∫øp ngay
        sortSelect.addEventListener("change", sortTable);

        // S·∫Øp x·∫øp m·∫∑c ƒë·ªãnh khi load (ƒêi·ªÉm AI cao nh·∫•t)
        sortTable();
      });
    </script>
    <script>
      document.querySelectorAll(".view-cv-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          const cvId = this.dataset.cv;
          const jobId = this.dataset.job;

          fetch(`/cv/${cvId}/?job_id=${jobId}`)
            .then((res) => res.json())
            .then((data) => {
              document.getElementById("cv-fullname").textContent = data.full_name || "Ch∆∞a x√°c ƒë·ªãnh";
              document.getElementById("cv-email").textContent = data.email || "‚Äî";
              document.getElementById("cv-phone").textContent = data.phone || "‚Äî";
              document.getElementById("cv-address").textContent = data.address || "‚Äî";
              document.getElementById("cv-skills").textContent = data.skills || "‚Äî";
              document.getElementById("cv-description").textContent = data.description || "‚Äî";
              document.getElementById("cv-score").textContent = data.score_data
                ? `${data.score_data.total_score} (${data.score_data.level})`
                : "‚Äî";

              const cvModal = new bootstrap.Modal(document.getElementById("cvDetailModal"));
              cvModal.show();
            })
            .catch((err) => console.error(err));
        });
      });
    </script>
    <script>
      document.querySelectorAll(".btn-send-email").forEach((button) => {
        button.addEventListener("click", function () {
          const url = this.getAttribute("data-url");
          const btn = this;
          const originalText = btn.innerHTML;

          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ƒêang g·ª≠i...';

          fetch(url, {
            method: "GET",
            headers: {
              "X-Requested-With": "XMLHttpRequest",
            },
          })
            .then((response) => {
              if (!response.ok) {
                return response.json().then((err) => {
                  throw err;
                });
              }
              return response.json();
            })
            .then((data) => {
              if (data.status === "success") {
                btn.classList.remove("btn-outline-success", "btn-send-email");
                btn.classList.add("btn-success");
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-check-circle"></i> ƒê√£ g·ª≠i xong';
              } else {
                alert("L·ªói: " + data.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
              }
            })
            .catch((error) => {
              console.error("Fetch Error:", error);
              alert("L·ªói k·∫øt n·ªëi server ho·∫∑c c·∫•u h√¨nh mail sai!");
              btn.disabled = false;
              btn.innerHTML = originalText;
            });
        });
      });
    </script>
  </body>
</html>
