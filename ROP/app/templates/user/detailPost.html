<!DOCTYPE html>
{% load static %}
<html lang="vi">
<head>
    <meta charset="UTF-8"/>
    <title>Chi tiết công việc</title>
    <link rel="stylesheet" href="{% static 'app/css_user/detailPost.css' %}"/>
    <link rel="stylesheet" href="{% static 'app/css_user/home.css' %}"/>
</head>
<body>

{% include "user/header.html" %}

<main class="main-detail-content">
    <div class="job-detail-container">

        <!-- JOB SUMMARY -->
        <section class="job-summary">
            <h1>{{ job.title }}</h1>

            <p class="detail-company">
                <i class="fas fa-building"></i> {{ job.company }}
            </p>

            <p class="detail-location">
                <i class="fas fa-map-marker-alt"></i> {{ job.location }}
            </p>

            <div class="summary-info">
                <span class="info-tag salary">
                    <i class="fas fa-money-bill-wave"></i>
                    {{ job.salary_min }} - {{ job.salary_max }} Triệu VND
                </span>

                <span class="info-tag type">
                    <i class="fas fa-clock"></i>
                    {{ job.create_at }} - {{ job.end_date }}
                </span>
            </div>
        </section>

        <div class="detail-body-grid">

            <!-- LEFT -->
            <section class="job-description">
                <h2>Mô Tả Công Việc</h2>
                <ul>
                    {% for i in jobDescript %}<li>{{ i }}</li>{% endfor %}
                </ul>

                <h2>Yêu Cầu</h2>
                <ul>
                    {% for i in jobRequire %}<li>{{ i }}</li>{% endfor %}
                </ul>

                <h2>Kỹ năng</h2>
                <ul>
                    {% for i in jobSkill %}<li>{{ i }}</li>{% endfor %}
                </ul>

                <h2>Phúc lợi</h2>
                <ul>
                    {% for i in jobBenefit %}<li>{{ i }}</li>{% endfor %}
                </ul>
            </section>

            <!-- RIGHT -->
            <aside class="application-form" id="application-form">
                <h3>Ứng tuyển công việc</h3>

                {% with user_cv=user_cvs.first %}
                {% if user_cv %}

                <div style="background:#f0f7ff;padding:15px;border-radius:8px;margin-bottom:15px;">
                    <strong>{{ user_cv.full_name }}</strong><br>
                    <small>Cập nhật: {{ user_cv.uploaded_at|date:"d/m/Y" }}</small>

                    <div id="ai-score-box" style="margin-top:15px;display:none;">
                        <p>Độ phù hợp:</p>
                        <span id="ai-percent">...</span> -
                        <span id="ai-level"></span>

                        <div style="background:#eee;height:10px;border-radius:5px;">
                            <div id="ai-progress-bar"
                                 style="height:100%;width:0%;border-radius:5px;"></div>
                        </div>
                    </div>
                </div>

                <form method="POST" action="{% url 'apply_job' job.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="full_name" value="{{ user_cv.full_name }}">
                    <input type="hidden" name="email" value="{{ user_cv.email }}">
                    <input type="hidden" name="phone" value="{{ user_cv.phone }}">
                    <input type="hidden" name="address" value="{{ user_cv.address }}">
                    <input type="hidden" name="description" value="{{ user_cv.description }}">
                    <input type="hidden" name="experience" value="{{ user_cv.skills }}">

                    <button class="btn-submit-cv" style="background:#28a745;">
                        Xác nhận ứng tuyển
                    </button>
                </form>

                <input type="hidden" id="existing-cv-id" value="{{ user_cv.id }}">

                {% else %}
                <p>Bạn chưa có hồ sơ.</p>
                {% endif %}
                {% endwith %}

            </aside>
        </div>
    </div>
</main>

<footer>
    <p>&copy; 2025 JobFinder</p>
</footer>

<script src="https://kit.fontawesome.com/a076d05399.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const cvId = document.getElementById('existing-cv-id')?.value;
    const jobId = "{{ job.id }}";

    if (!cvId) return;

    fetch(`/cv/json/${cvId}/?job_id=${jobId}`)
        .then(res => res.json())
        .then(data => {
            if (!data.score_data) return;

            const score = data.score_data.total_score;
            const level = data.score_data.level;

            const box = document.getElementById('ai-score-box');
            const percent = document.getElementById('ai-percent');
            const levelEl = document.getElementById('ai-level');
            const bar = document.getElementById('ai-progress-bar');

            let color = score >= 75 ? "#28a745" :
                        score >= 50 ? "#ffc107" : "#dc3545";

            box.style.display = "block";
            percent.innerText = score + "%";
            levelEl.innerText = level;
            levelEl.style.color = color;

            bar.style.width = score + "%";
            bar.style.backgroundColor = color;
        })
        .catch(err => console.error("AI error:", err));
});
</script>

</body>
</html>
