<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Title</title>
    <link rel="stylesheet" href="{% static 'app/css_user/detailPost.css' %}"/>
    <link rel="stylesheet" href="{% static 'app/css_user/home.css' %}"/>
</head>
<body>
{% include "user/header.html" %}

<main class="main-detail-content">
    <div class="job-detail-container">
        <!-- === JOB SUMMARY === -->
        <section class="job-summary">
            <h1>{{job.title}}</h1>

            <p class="detail-company">
                <i class="fas fa-building"></i> {{job.company}}
            </p>

            <p class="detail-location">
                <i class="fas fa-map-marker-alt"></i> {{job.location}}
            </p>

            <div class="summary-info">
            <span class="info-tag salary">
              <i class="fas fa-money-bill-wave"></i> {{job.salary_min}} -
              {{job.salary_max}} Triệu VND
            </span>

                <span class="info-tag type">
              <i class="fas fa-clock"></i> {{job.create_at}} - {{job.end_date}}
            </span>
            </div>
        </section>

        <!-- === JOB DETAILS + FORM === -->
        <div class="detail-body-grid">
            <!-- LEFT SIDE: JOB DESCRIPTION -->
            <section class="job-description">
                <h2>Mô Tả Công Việc</h2>
                <ul>
                    {% for item in jobDescript %}
                    <li>{{item}}</li>
                    {% endfor%}
                </ul>

                <h2>Yêu Cầu Công Việc</h2>
                <ul>
                    {% for item in jobRequire %}
                    <li>{{item}}</li>
                    {% endfor%}
                </ul>
                <h2>Kỹ năng</h2>
                <ul>
                    {% for item in jobSkill %}
                    <li>{{item}}</li>
                    {% endfor%}
                </ul>

                <h2>Phúc Lợi</h2>
                <ul>
                    {% for item in jobBenefit %}
                    <li>{{item}}</li>
                    {% endfor%}
                </ul>
            </section>

            {% load tz %} {# nếu bạn dùng timezone-aware datetime #}

            <aside class="application-form" id="application-form">
                <h3>Form Ứng Tuyển Nhanh</h3>
            
                <p style="font-size: 12px; color: gray;">Hồ sơ tìm thấy: {{ user_cvs.count }}</p>

                {% if user_cvs %}
                <div class="form-group" style="background: #f0f7ff; padding: 15px; border-radius: 8px; border: 1px dashed #0056b3; display: block !important;">
                    <label style="color: #0056b3; font-weight: bold;"><i class="fas fa-magic"></i> AI Điền nhanh & Chấm điểm:</label>
                    <select id="cv-selector" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #0056b3;">
                        <option value="">-- Chọn hồ sơ của bạn --</option>
                        {% for cv in user_cvs %}
                            <option value="{{ cv.id }}">{{ cv.full_name }} ({{ cv.uploaded_at|date:"d/m/Y" }})</option>
                        {% endfor %}
                    </select>
                    
                    <div id="ai-score-box" style="display: none; margin-top: 10px; align-items: center; gap: 8px; background: #f9f9f9; padding: 8px 12px; border-radius: 20px; width: fit-content; border: 1px solid #eee;">
                        <span id="ai-dot" style="height: 12px; width: 12px; border-radius: 50%; display: inline-block; box-shadow: 0 0 5px rgba(0,0,0,0.1);"></span>
                        
                        <span id="ai-level" style="font-size: 14px; font-weight: bold;"></span>
                   </div>
                </div>
                {% endif %}
            
                <form action="{% url 'apply_job' job.id %}" method="POST" id="apply-form">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="full_name">Họ và Tên (*)</label>
                        <input type="text" id="full_name" name="full_name" required placeholder="Nguyễn Văn A"/>
                    </div>

                    <!-- Email -->
                    <div class="form-group">
                        <label for="email">Email (*)</label>
                        <input type="email" id="email" name="email" required placeholder="example@gmail.com"/>
                    </div>

                    <div class="form-group">
                        <label for="phone">Số điện thoại (*)</label>
                        <input type="tel" id="phone" name="phone" required placeholder="0123456789"/>
                    </div>

                    <div class="form-group">
                        <label for="address">Địa chỉ</label>
                        <input type="text" id="address" name="address" required placeholder="Thành phố/ tỉnh nơi ở"/>
                    </div>

                    <div class="form-group">
                        <label for="description">Mô tả bản thân</label>
                        <textarea id="description" name="description" rows="4"
                                  placeholder="Mô tả kinh nghiệm, bằng cấp và các thành tựu, ưu điểm và nhược điểm của bạn..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="experience">Kỹ năng</label>
                        <textarea id="experience" name="experience" rows="4"
                                  placeholder="Mô tả kinh nghiệm và kỹ năng của bạn..."></textarea>
                    </div>
                    <button type="submit" class="btn-submit-cv">Gửi Hồ Sơ Ứng Tuyển</button>

                </form>
            </aside>

        </div>
    </div>
</main>

<footer>
    <p>&copy; 2025 JobFinder. All rights reserved.</p>
</footer>
<script
        src="https://kit.fontawesome.com/a076d05399.js"
        crossorigin="anonymous"
></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cvSelector = document.getElementById('cv-selector');
        const urlParams = new URLSearchParams(window.location.search);
        const cvIdFromUrl = urlParams.get('cv_id');
        const jobId = "{{ job.id }}";

        // Hàm fetch dữ liệu tách riêng để dùng chung
        function loadCvToForm(cvId) {
            if (!cvId) return;
            fetch(`/cv/json/${cvId}/?job_id=${jobId}`) // Sửa lại đúng path /cv/json/ như trong urls.py của bạn
                .then(response => response.json())
                .then(data => {
                    document.getElementById('full_name').value = data.full_name || '';
                    document.getElementById('email').value = data.email || '';
                    document.getElementById('phone').value = data.phone || '';
                    document.getElementById('address').value = data.address || '';
                    document.getElementById('description').value = data.description || '';
                    document.getElementById('experience').value = data.skills || '';

                    if (data.score_data) {
                const scoreBox = document.getElementById('ai-score-box');
                const aiDot = document.getElementById('ai-dot');
                const aiLevel = document.getElementById('ai-level');
        
                scoreBox.style.display = 'flex'; // Dùng flex để icon và chữ nằm hàng ngang
                
                // 1. Xác định màu sắc dựa trên điểm (nhưng không hiện số điểm ra ngoài)
                let color = "";
                if (data.score_data.total_score >= 75) {
                    color = "#28a745"; // Xanh lá - Rất tốt
                } else if (data.score_data.total_score >= 50) {
                    color = "#ffc107"; // Vàng - Khá
                } else {
                    color = "#dc3545"; // Đỏ - Thấp
                }
                // 2. Gán màu và nội dung
        aiDot.style.backgroundColor = color;
        aiLevel.innerText = "Mức độ phù hợp: " + data.score_data.level;
        aiLevel.style.color = color;
    }
                });
        }

        if (cvIdFromUrl && cvSelector) {
            cvSelector.value = cvIdFromUrl;
            loadCvToForm(cvIdFromUrl);
            document.getElementById('application-form').scrollIntoView({ behavior: 'smooth' });
        }

        // Nếu người dùng tự tay chọn trên Select
        cvSelector?.addEventListener('change', function() {
            if (!this.value) {
                document.getElementById('apply-form').reset();
                document.getElementById('ai-score-box').style.display = 'none';
            } else {
                loadCvToForm(this.value);
            }
        });
    });
</script>
</body>
</html>
